<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: db.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: db.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mongoose = require('mongoose');
mongoose.Promise = Promise;

const
    passportLocalMongoose = require('passport-local-mongoose'),
    logger = require('./logger'),
    validate = require('./validate');
    
var 
    Account,
    Exchange,
    Ticker,
    Notification,
    NetNode,
    LightNodeState,
    MasterNodeState;

function initModels(conn) {
    Account = require('../models/Account').createModel(conn);
    Exchange = require('../models/Exchange').createModel(conn);
    Ticker = require('../models/Ticker').createModel(conn);
    Notification = require('../models/Notification').createModel(conn);
    NetNode = require('../models/NetNode').createModel(conn);
    LightNodeState = require('../models/LightNodeState').createModel(conn);
    MasterNodeState = require('../models/MasterNodeState').createModel(conn);
    Action = require('../models/Action').createModel(conn);
}

/**
 * Connect to mongo
 * @param {string} url mongo url
 */

async function connect(url) {
    logger.debug('DB', url);
    var conn = await mongoose.createConnection(url);

    initModels(conn);

    await mongoose.connect(url, {
        useMongoClient: true
    });
}

/**
 * Setup authentication account for remote nodes
 * @param {Credentials} options {username, password}
 */

async function setupAccount(account) {
    //Account.deleteAll

    account = new Account(account);

    await account.save();
}

/**
 * Return Account model for passport
 * @returns {Account} Account model
 */

function getAccountModel() {
    return Account;
}

/**
 * Save tickers
 * @param {array} tickers Tickers array
 */

async function saveTickers(tickers) {
//    logger.debug('saveTickers', tickers);
    await tickers.forEach(async (item)=>{
        await this.addTicker(item);
    });
}

/**
 * Add ticker to db
 * @param {Ticker} ticker Ticker object
 */

async function addTicker(ticker) {
//    logger.debug(`addTicker ${JSON.stringify(ticker)}`)

    validate.object(ticker, 'addTicker ticker');
    validate.string(ticker.name, 'addTicker ticker.name');
    validate.number(ticker.lastest, 'addTicker ticker.lastest');
    validate.string(ticker.updateTime, 'addTicker ticker.updateTime');
    validate.string(ticker.timestamp, 'addTicker ticker.timestamp');
    
    var exchange = await Exchange.findOne({ name: ticker.name });
    if (!exchange) {
        exchange = new Exchange({
            name: ticker.name
        });
        await exchange.save();
    }
    ticker.exchange = exchange;
    ticker.symbol = `${ticker.name} USD/ETH`;
    ticker = new Ticker(ticker);
    await ticker.save();
}

/**
 * Get tickers
 * @returns {array} Tickers array
 */

async function getTickers() {
    var tickers = await Ticker.find();
    return tickers;
}

async function addNotification(notification) {
    var notification = new Notification(notification);
    await notification.save();
}

async function addNetNode(node) {
    var node = new NetNode(node);
    await node.save();
}

async function removeNetNode(node) {
    await NetNode.remove({ id: node.id });
}

async function getNetNodes() {
    var nodes = await NetNode.find();
    return nodes;
}

async function updateLightNodeState(state) {
    var state = new LightNodeState({
        id: state.id,
        startTime: state.startTime,
        uptime: state.uptime,
        lastUpdate: state.lastUpdate
    });

    state.save();
}

async function updateMasterNodeState(state) {
    var state = new MasterNodeState({
        id: state.id,
        startTime: state.startTime,
        uptime: state.uptime,
        lastUpdate: state.lastUpdate,
        lightNodesTotal: state.lightNodesTotal,
        lightNodesAlive: state.lightNodesAlive
    });

    await state.save();
}

/**
 * Add action
 * @param {Action} action Action
 */

async function addAction(action) {
    try {
        var action = new Action(action);

        await action.save();
    }
    catch (e) {
        logger.error('db.addAction error', e);
    }
}

/**
 * Get actions
 * @param {ActionsFilter} filter Actions filter
 * @returns {Array} Actions
 */

async function getActions(filter) {
    var actions = await Action.find();
    return actions;
}

module.exports = {
    connect,
    setupAccount,
    getAccountModel,
    saveTickers,
    addTicker,
    getTickers,
    addNotification,
    addNetNode,
    getNetNodes,
    updateLightNodeState,
    updateMasterNodeState,
    addAction,
    getActions
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addAction">addAction</a></li><li><a href="global.html#addTicker">addTicker</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#getAccountModel">getAccountModel</a></li><li><a href="global.html#getActions">getActions</a></li><li><a href="global.html#getTickers">getTickers</a></li><li><a href="global.html#saveTickers">saveTickers</a></li><li><a href="global.html#setupAccount">setupAccount</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Feb 10 2018 05:11:21 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
